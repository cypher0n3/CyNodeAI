services:
  postgres:
    image: postgres:16-alpine
    container_name: cynodeai-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-cynodeai}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-cynodeai-dev-password}
      POSTGRES_DB: ${POSTGRES_DB:-cynodeai}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - cynodeai-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 2s
      timeout: 2s
      retries: 30

  control-plane:
    build:
      context: ..
      dockerfile: orchestrator/cmd/control-plane/Containerfile
    container_name: cynodeai-control-plane
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgres://cynodeai:cynodeai-dev-password@postgres:5432/cynodeai?sslmode=disable}
      CONTROL_PLANE_LISTEN_ADDR: ":8082"
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-change-me}
      NODE_REGISTRATION_PSK: ${NODE_REGISTRATION_PSK:-dev-node-psk-secret}
      BOOTSTRAP_ADMIN_PASSWORD: ${BOOTSTRAP_ADMIN_PASSWORD:-admin123}
      WORKER_API_URL: ${WORKER_API_URL:-http://host.containers.internal:8081}
      WORKER_API_BEARER_TOKEN: ${WORKER_API_BEARER_TOKEN:-dev-worker-api-token-change-me}
      DISPATCHER_ENABLED: ${DISPATCHER_ENABLED:-true}
    ports:
      - "${CONTROL_PLANE_PORT:-8082}:8082"
    depends_on:
      postgres:
        condition: service_healthy

  user-gateway:
    build:
      context: ..
      dockerfile: orchestrator/cmd/user-gateway/Containerfile
    container_name: cynodeai-user-gateway
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgres://cynodeai:cynodeai-dev-password@postgres:5432/cynodeai?sslmode=disable}
      USER_GATEWAY_LISTEN_ADDR: ":8080"
      JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-change-me}
    ports:
      - "${USER_GATEWAY_PORT:-8080}:8080"
    depends_on:
      postgres:
        condition: service_healthy

  mcp-gateway:
    profiles: ["optional"]
    build:
      context: ..
      dockerfile: orchestrator/cmd/mcp-gateway/Containerfile
    container_name: cynodeai-mcp-gateway
    environment:
      LISTEN_ADDR: ":8083"
    ports:
      - "${MCP_GATEWAY_PORT:-8083}:8083"

  api-egress:
    profiles: ["optional"]
    build:
      context: ..
      dockerfile: orchestrator/cmd/api-egress/Containerfile
    container_name: cynodeai-api-egress
    environment:
      LISTEN_ADDR: ":8084"
    ports:
      - "${API_EGRESS_PORT:-8084}:8084"

volumes:
  cynodeai-postgres-data: {}
